<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengecaman Wajah</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@latest/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.1.0/dist/tf-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.1.0/dist/tf-backend-webgl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@2.0.1/dist/hand-pose-detection.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); /* Fon Matrix */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --bg-color: #f0f2f5;
            --text-color: #212529;
            --matrix-green: #39FF14;
            --border-radius: 12px;
        }
        body {
            margin: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            box-sizing: border-box;
            cursor: default; /* Set cursor default */
        }
        #app-container {
            width: 100vw;
            height: 100vh;
            background-color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #video-container {
            position: relative;
            background-color: #000;
            width: 100%;
            flex-grow: 1; /* Let it fill available vertical space */
            overflow: hidden; /* Memastikan tiada apa yang terkeluar */
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* Invert video feed */
            object-fit: cover;
            display: none; /* Hidden by default */
        }
        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #placeholder {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            flex-direction: column;
            text-align: center;
            padding: 1rem;
            z-index: 10;
            background-color: #000; /* Latar belakang placeholder ditetapkan */
        }
        #placeholder svg { width: 64px; height: 64px; margin-bottom: 1rem; }
        #placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--border-radius);
            outline: 1px solid rgba(255, 255, 255, 0.2); /* Garis sempadan ditambah */
        }
        
        #controls {
            padding: 1.5rem;
            background-color: #ffffff;
            border-top: 1px solid #dee2e6;
            z-index: 200; /* Ensure controls are on top */
        }
        .btn-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            color: white;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn:active { transform: scale(0.98); }
        #register-btn { background-color: var(--primary-color); }
        #recognize-btn { background-color: var(--success-color); }
        
        #registration-form, #registration-choice, #update-confirmation {
            display: none;
            flex-direction: column;
            gap: 1rem;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input {
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
        }
        #status-message {
            text-align: center;
            padding-top: 1rem;
            font-weight: 600;
        }
        #error-message {
            padding: 1rem; background-color: #f8d7da; color: #721c24;
            text-align: center; display: none;
        }

        #loading-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: white;
            flex-direction: column;
        }
        #loading-text {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            color: var(--matrix-green);
            margin-bottom: 1rem;
        }
        #progress-bar-container {
            width: 80%;
            max-width: 400px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--matrix-green);
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background: var(--matrix-green);
            transition: width 0.5s ease;
        }

        #success-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: none; /* Initially hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: var(--matrix-green);
            font-family: 'VT323', monospace;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #matrix-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
        .success-content {
            position: relative;
            z-index: 1;
        }
        #success-screen h1 {
            font-size: 2.5rem;
            letter-spacing: 3px;
            text-shadow: 0 0 15px var(--matrix-green);
        }
        #success-screen p {
            font-size: 1.5rem;
        }
        #version-info {
            text-align: right;
            font-size: 0.7rem;
            color: #adb5bd;
            padding-top: 1rem;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="error-message"></div>
    <div id="video-container">
        <div id="placeholder">
            <!-- Content will be injected by JavaScript -->
        </div>
        <video id="video" playsinline autoplay muted></video>
        <canvas id="overlay-canvas"></canvas>
    </div>
    <div id="controls">
        <div id="main-menu" class="btn-group">
            <button id="register-btn" class="btn">Daftar Pengguna</button>
            <button id="recognize-btn" class="btn">Mula Pengesanan</button>
        </div>
        <div id="registration-choice">
             <div class="btn-group">
                 <button id="register-camera-btn" class="btn" style="background-color: var(--primary-color);">Guna Kamera</button>
                 <button id="register-image-btn" class="btn" style="background-color: var(--primary-color);">Muat Naik Gambar</button>
             </div>
             <button id="cancel-choice-btn" class="btn" style="background-color: var(--secondary-color); margin-top: 1rem;">Batal</button>
        </div>
        <form id="registration-form">
             <div id="image-upload-group" class="form-group" style="display: none;">
                 <label for="image-upload-input">Pilih Gambar Potret:</label>
                 <input type="file" id="image-upload-input" accept="image/*">
             </div>
            <div class="form-group">
                <label for="name-input">Nama:</label>
                <input type="text" id="name-input" required placeholder="Cth: Ali Ayub">
            </div>
            <div class="form-group">
                <label for="position-input">Jawatan:</label>
                <input type="text" id="position-input" required placeholder="Cth: JA3">
            </div>
            <div class="btn-group">
                <button type="submit" class="btn" style="background-color: var(--success-color);">Simpan</button>
                <button type="button" id="cancel-form-btn" class="btn" style="background-color: var(--secondary-color);">Batal</button>
            </div>
        </form>
        <div id="update-confirmation">
            <p id="update-message"></p>
            <div class="btn-group">
                <button id="confirm-update-btn" class="btn" style="background-color: var(--success-color);">Ya, Kemas Kini</button>
                <button id="cancel-update-btn" class="btn" style="background-color: var(--secondary-color);">Batal</button>
            </div>
        </div>
        <div id="status-message"></div>
        <div id="version-info">versi 1.4.11</div>
    </div>
    <div id="success-screen">
        <canvas id="matrix-canvas"></canvas>
        <div class="success-content">
            <h1 id="success-title"></h1>
            <p id="success-subtitle"></p>
        </div>
    </div>
    <div id="loading-overlay">
        <div id="loading-text">Memuatkan Model AI...</div>
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
    </div>
</div>

<script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
     apiKey: "AIzaSyDrICpXd4ukkpnoFrRleTzEcR87vIoTM3s",
     authDomain: "gimikrt-cf2e4.firebaseapp.com",
     projectId: "gimikrt-cf2e4",
     storageBucket: "gimikrt-cf2e4.appspot.com",
     messagingSenderId: "878304778253",
     appId: "1:878304778253:web:470cc421f6cf6ba0f21d44",
     measurementId: "G-FBMMM8ZG14"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const video = document.getElementById('video');
    const overlayCanvas = document.getElementById('overlay-canvas');
    const controls = document.getElementById('controls');
    const mainMenu = document.getElementById('main-menu');
    const registerBtn = document.getElementById('register-btn');
    const recognizeBtn = document.getElementById('recognize-btn');
    const registrationChoice = document.getElementById('registration-choice');
    const registerCameraBtn = document.getElementById('register-camera-btn');
    const registerImageBtn = document.getElementById('register-image-btn');
    const cancelChoiceBtn = document.getElementById('cancel-choice-btn');
    const registrationForm = document.getElementById('registration-form');
    const imageUploadGroup = document.getElementById('image-upload-group');
    const imageUploadInput = document.getElementById('image-upload-input');
    const cancelFormBtn = document.getElementById('cancel-form-btn');
    const statusMessage = document.getElementById('status-message');
    const placeholder = document.getElementById('placeholder');
    const errorMessage = document.getElementById('error-message');
    const successScreen = document.getElementById('success-screen');
    const successTitle = document.getElementById('success-title');
    const successSubtitle = document.getElementById('success-subtitle');
    const matrixCanvas = document.getElementById('matrix-canvas');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const progressBar = document.getElementById('progress-bar');
    const updateConfirmation = document.getElementById('update-confirmation');
    const updateMessage = document.getElementById('update-message');
    const confirmUpdateBtn = document.getElementById('confirm-update-btn');
    const cancelUpdateBtn = document.getElementById('cancel-update-btn');

    let stream = null;
    let detectionInterval = null;
    let guideInterval = null; 
    let faceMatcher = null;
    let registeredUsers = [];
    let firstMatchTime = null;
    let handDetector = null;
    let handScanStartTime = null;
    let finalVerificationTimer = null;
    let matrixAnimationId = null;
    let areModelsLoaded = false;
    let userToUpdate = null;
    let registrationScanInterval = null;
    let roboticVoice = null;
    let lockedOnUser = null;
    let isReadyForHandScan = false;

    const FACE_MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    
    const initialPlaceholderContent = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v16H4V4zm8 11c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
        <span id="placeholder-text">Sistem Sedia</span>`;

    function setPlaceholderContent(htmlContent) {
        placeholder.innerHTML = htmlContent;
    }
    
    function showLoadingBar(text, duration) {
        loadingText.textContent = text;
        progressBar.style.width = '0%';
        loadingOverlay.style.display = 'flex';
        void progressBar.offsetWidth;
        progressBar.style.transition = `width ${duration}s ease-in-out`;
        progressBar.style.width = '100%';
    }

    function hideLoadingBar() {
        loadingOverlay.style.display = 'none';
        progressBar.style.width = '0%';
    }

    async function initializeAppFlow() {
        registerBtn.disabled = true;
        recognizeBtn.disabled = true;
        initializeTTS();
        await loadAllModels();
        await loadRegisteredUsers();
    }


    async function loadAllModels(onComplete) {
        if (areModelsLoaded) {
            if (onComplete) onComplete();
            return;
        }

        showLoadingBar('Memuatkan Model AI...', 3);
        
        try {
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(FACE_MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(FACE_MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(FACE_MODEL_URL)
            ]);
            
            const model = handPoseDetection.SupportedModels.MediaPipeHands;
            const detectorConfig = {
              runtime: 'mediapipe',
              solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240',
              modelType: 'lite'
            };
            handDetector = await handPoseDetection.createDetector(model, detectorConfig);
            areModelsLoaded = true;

            setTimeout(() => {
                hideLoadingBar();
                if (onComplete) onComplete();
            }, 3000);

        } catch (err) {
            console.error(err);
            showError("Gagal memuatkan model AI. Sila muat semula.");
            hideLoadingBar();
        }
    }

    function unloadModels() {
        areModelsLoaded = false;
        handDetector = null;
    }

    async function loadRegisteredUsers() {
        statusMessage.innerText = 'Memuatkan data pengguna...';
        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            const users = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                users.push({
                    id: doc.id,
                    name: data.name,
                    position: data.position,
                    descriptor: new Float32Array(data.descriptor)
                });
            });
            registeredUsers = users;

            if (registeredUsers.length > 0) {
                const labeledDescriptors = registeredUsers.map(user =>
                    new faceapi.LabeledFaceDescriptors(user.name, [user.descriptor])
                );
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);
                statusMessage.innerText = `Sistem Sedia.`;
                recognizeBtn.disabled = false;
            } else {
                statusMessage.innerText = 'Tiada pengguna didaftarkan. Sila daftar.';
                recognizeBtn.style.display = 'none';
            }
            registerBtn.disabled = false;
        } catch (e) {
            console.error("Error fetching users: ", e);
            showError("Gagal memuatkan data pengguna.");
            statusMessage.innerText = 'Gagal memuatkan data.';
        }
    }
    
    async function startCamera() {
        try {
            if (stream) {
                video.play();
                return true;
            };
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            return true;
        } catch (err) {
            showError("Tidak dapat mengakses kamera.");
            return false;
        }
    }
    
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }
    
    function showVideoFeed() {
        video.style.display = 'block';
        placeholder.style.display = 'none';
    }

    function hideVideoFeed() {
        video.style.display = 'none';
        placeholder.style.display = 'flex';
    }
    
    function drawMatrixText(context, text, x, y, size = 24) {
        context.font = `${size}px VT323, monospace`;
        context.fillStyle = '#39FF14';
        context.shadowColor = '#39FF14';
        context.shadowBlur = 10;
        context.textAlign = 'center';
        context.fillText(text, x, y);
    }
    
    function drawMatrixInfo(context, box, name, position) {
        const textLines = [
            name.toUpperCase(),
            position.toUpperCase(),
        ];
        context.font = '20px VT323, monospace';
        const textWidth = Math.max(...textLines.map(line => context.measureText(line).width));
        const textHeight = 55;
        let startX = box.x;
        let startY = box.y + box.height + 5;

        if (startY + textHeight > overlayCanvas.height) {
            startY = box.y - textHeight - 5;
        }
        if (startX + textWidth + 20 > overlayCanvas.width) {
            startX = overlayCanvas.width - textWidth - 20;
        }
        if (startX < 0) {
            startX = 0;
        }

        context.fillStyle = 'rgba(0, 0, 0, 0.7)';
        context.fillRect(startX, startY, textWidth + 20, textHeight);
        context.textAlign = 'left';
        drawMatrixText(context, textLines[0], startX + 10, startY + 20, 20);
        drawMatrixText(context, textLines[1], startX + 10, startY + 45, 20);
    }

    function drawHandBox(context, hands, progress) {
        if (hands.length === 0) return;

        const keypoints = hands[0].keypoints;
        const xCoords = keypoints.map(p => p.x);
        const yCoords = keypoints.map(p => p.y);
        
        const xMin = Math.min(...xCoords);
        const yMin = Math.min(...yCoords);
        const xMax = Math.max(...xCoords);
        const yMax = Math.max(...yCoords);
        
        const boxWidth = xMax - xMin;
        const boxHeight = yMax - yMin;

        const padding = 20;
        const paddedXMin = xMin - padding;
        const paddedYMin = yMin - padding;
        const paddedWidth = boxWidth + padding * 2;
        const paddedHeight = boxHeight + padding * 2;

        const scaleX = overlayCanvas.width / video.videoWidth;
        const scaleY = overlayCanvas.height / video.videoHeight;

        const x = paddedXMin * scaleX;
        const y = paddedYMin * scaleY;
        const width = paddedWidth * scaleX;
        const height = paddedHeight * scaleY;
        
        const flippedX = overlayCanvas.width - x - width;

        context.strokeStyle = 'rgba(40, 167, 69, 0.7)';
        context.lineWidth = 2;
        context.strokeRect(flippedX, y, width, height);

        if (progress !== undefined) {
            drawProgressBar(context, flippedX, y + height + 5, width, 8, progress);
        }
    }
    
    function drawProgressBar(context, x, y, width, height, progress) {
        const greenColor = getComputedStyle(document.documentElement).getPropertyValue('--matrix-green').trim();
        context.fillStyle = 'rgba(255, 255, 255, 0.3)';
        context.fillRect(x, y, width, height);
        context.fillStyle = greenColor;
        context.fillRect(x, y, width * progress, height);
    }

    function initializeTTS() {
        const setVoice = () => {
            const voices = window.speechSynthesis.getVoices();
            roboticVoice = voices.find(voice => voice.name.includes('Google US English')) ||
                           voices.find(voice => voice.name.includes('Samantha')) || 
                           voices.find(voice => voice.name.includes('Microsoft Zira')) || 
                           voices.find(voice => voice.lang === 'en-US') ||
                           voices[0];
        };

        if ('speechSynthesis' in window) {
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = setVoice;
            }
            setVoice();
        }
    }

    function speak(text, onEndCallback = null) {
        if ('speechSynthesis' in window && roboticVoice) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = roboticVoice;
            utterance.pitch = 1.1;
            utterance.rate = 1.1;
            if (onEndCallback) {
                utterance.onend = onEndCallback;
            }
            window.speechSynthesis.speak(utterance);
        } else if (onEndCallback) {
            onEndCallback();
        }
    }

    function getGreeting() {
        const hour = new Date().getHours();
        if (hour < 12) return "Good Morning";
        if (hour < 18) return "Good Afternoon";
        return "Good Evening";
    }

    function playDistortionEffect(callback) {
        let count = 0;
        const distortionInterval = setInterval(() => {
            const context = overlayCanvas.getContext('2d');
            const w = overlayCanvas.width;
            const h = overlayCanvas.height;
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                const spliceWidth = w - x;
                const spliceHeight = Math.random() * 10 + 5;
                context.drawImage(overlayCanvas, 0, y, spliceWidth, spliceHeight, x, y, spliceWidth, spliceHeight);
                context.drawImage(overlayCanvas, spliceWidth, y, x, spliceHeight, 0, y, x, spliceHeight);
            }
            count++;
            if (count > 20) {
                clearInterval(distortionInterval);
                callback();
            }
        }, 50);
    }
    
    function showSuccessScreen() {
        clearAllIntervals();
        stopCamera();

        showLoadingBar('Memproses Pelancaran...', 1);
        setTimeout(() => {
            hideLoadingBar();
            unloadModels();
            
            window.addEventListener('keydown', handleEscKey);

            successScreen.style.display = 'flex';
            setTimeout(() => {
                successScreen.style.opacity = 1;
                startMatrixAnimation();
                setTimeout(() => {
                    decodeTextEffect('PENGESAHAN BERJAYA', successTitle, () => {
                        decodeTextEffect('Pelancaran Telah Disempurnakan', successSubtitle, null);
                    });
                }, 500);
            }, 10);
        }, 1000);
    }

    function startRecognition() {
        clearAllIntervals();
        startCamera().then(success => {
            if (!success) return;
            showVideoFeed();
            controls.style.display = 'none';
            firstMatchTime = null;
            lockedOnUser = null;
            isReadyForHandScan = false;
            
            window.addEventListener('keydown', handleEscKey);

            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(overlayCanvas, displaySize);

            detectionInterval = setInterval(async () => {
                const context = overlayCanvas.getContext('2d');
                context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                
                if (lockedOnUser) {
                    // --- FASA 2: PENGESAHAN TANGAN ---
                    const [faceDetections, hands] = await Promise.all([
                        faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 })),
                        handDetector ? handDetector.estimateHands(video, { flipHorizontal: false }) : Promise.resolve([])
                    ]);

                    const resizedDetections = faceapi.resizeResults(faceDetections, displaySize);
                    
                    if (resizedDetections.length > 0 && resizedDetections[0]) {
                        const detection = resizedDetections[0];
                        if (detection && detection.box) {
                            const { box } = detection;
                            const paddingX = box.width * 0.3;
                            const paddingY = box.height * 0.7;
                            const paddedBox = {
                                x: box.x - paddingX / 2,
                                y: box.y - paddingY * 0.6,
                                width: box.width + paddingX,
                                height: box.height + paddingY
                            };
                            const flippedBox = { x: overlayCanvas.width - paddedBox.x - paddedBox.width, y: paddedBox.y, width: paddedBox.width, height: paddedBox.height };
                            
                            new faceapi.draw.DrawBox(flippedBox, { boxColor: 'rgba(40, 167, 69, 0.7)' }).draw(overlayCanvas);
                            drawMatrixInfo(context, flippedBox, lockedOnUser.name, lockedOnUser.position);
                        }
                    }

                    if (isReadyForHandScan) {
                        const isHandDetected = hands.length > 0;
                        if (isHandDetected) {
                            if (handScanStartTime === null) handScanStartTime = Date.now();
                            const handProgress = Math.min((Date.now() - handScanStartTime) / 3000, 1);
                            drawHandBox(context, hands, handProgress);
                            
                            if (handProgress >= 1 && !finalVerificationTimer) {
                                finalVerificationTimer = setTimeout(() => {
                                    const greeting = getGreeting();
                                    speak(`Second verification complete. ${greeting} ${lockedOnUser.name}`, () => {
                                        playDistortionEffect(() => {
                                            setTimeout(showSuccessScreen, 500);
                                        });
                                    });
                                }, 100);
                            }
                        } else {
                            handScanStartTime = null;
                            if(finalVerificationTimer) clearTimeout(finalVerificationTimer);
                            finalVerificationTimer = null;
                            drawMatrixText(context, "SHOW YOUR PALM FOR VERIFICATION", overlayCanvas.width / 2, 50, 32);
                        }
                    }

                } else {
                    // --- FASA 1: PENGESAHAN WAJAH ---
                    const faceDetections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 })).withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(faceDetections, displaySize);
                    
                    let recognizedFaceFoundThisFrame = false;

                    if (resizedDetections.length > 0) {
                        for (const detection of resizedDetections) {
                            const { flippedBox, bestMatch } = processDetection(detection);
                            if (bestMatch.label !== 'unknown') {
                                recognizedFaceFoundThisFrame = true;
                                if (firstMatchTime === null) firstMatchTime = Date.now();
                                
                                new faceapi.draw.DrawBox(flippedBox, { boxColor: 'rgba(40, 167, 69, 0.7)' }).draw(overlayCanvas);
                                const faceProgress = Math.min((Date.now() - firstMatchTime) / 3000, 1);
                                drawProgressBar(context, flippedBox.x, flippedBox.y + flippedBox.height + 5, flippedBox.width, 8, faceProgress);

                                if (faceProgress >= 1) {
                                    const matchedUser = registeredUsers.find(user => user.name === bestMatch.label);
                                    if (matchedUser && !lockedOnUser) {
                                        lockedOnUser = { name: matchedUser.name, position: matchedUser.position };
                                        speak("Identity verified. Standby for second layer security.", () => {
                                            isReadyForHandScan = true;
                                        });
                                    }
                                }
                                break; 
                            }
                        }
                    }
                    
                    if (!recognizedFaceFoundThisFrame) {
                        firstMatchTime = null;
                        if (resizedDetections.length > 0) {
                            const { flippedBox } = processDetection(resizedDetections[0]);
                             new faceapi.draw.DrawBox(flippedBox, { label: `Mencari ID...` }).draw(overlayCanvas);
                        } else {
                            drawMatrixText(context, "SEMAKAN SEDANG DIJALANKAN", overlayCanvas.width / 2, overlayCanvas.height / 2);
                        }
                    }
                }
            }, 100);
        });
    }

    const processDetection = (detection) => {
        const box = detection.detection.box;
        const paddingX = box.width * 0.3;
        const paddingY = box.height * 0.7;
        const paddedBox = {
            x: box.x - paddingX / 2,
            y: box.y - paddingY * 0.6,
            width: box.width + paddingX,
            height: box.height + paddingY
        };
        const flippedBox = { x: overlayCanvas.width - paddedBox.x - paddedBox.width, y: paddedBox.y, width: paddedBox.width, height: paddedBox.height };
        const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
        const score = detection.detection.score;
        return { flippedBox, bestMatch, score };
    };
    
    function startRegistrationGuide() {
        clearAllIntervals();
        registrationChoice.style.display = 'none';
        startCamera().then(success => {
            if (!success) return;
            showVideoFeed();
            imageUploadGroup.style.display = 'none';
            registrationForm.style.display = 'flex';
            mainMenu.style.display = 'none';
            
            document.getElementById('name-input').value = '';
            document.getElementById('position-input').value = '';
            statusMessage.innerText = "Sistem sedang mengimbas...";

            let scanHasFilled = false;
            registrationScanInterval = setInterval(async () => {
                if (scanHasFilled) return;

                const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 })).withFaceLandmarks().withFaceDescriptor();

                if (detection && faceMatcher) {
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) {
                        const matchedUser = registeredUsers.find(u => u.name === bestMatch.label);
                        if (matchedUser) {
                            document.getElementById('name-input').value = matchedUser.name;
                            document.getElementById('position-input').value = matchedUser.position;
                            statusMessage.innerText = `Wajah dikesan sebagai ${matchedUser.name}. Kemas kini maklumat jika perlu.`;
                            scanHasFilled = true;
                        }
                    }
                }
            }, 1000);

            const drawStaticGuide = () => {
                const context = overlayCanvas.getContext('2d');
                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                if (overlayCanvas.width !== displaySize.width || overlayCanvas.height !== displaySize.height) {
                    faceapi.matchDimensions(overlayCanvas, displaySize);
                }
                context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                const rectWidth = overlayCanvas.width * 0.4;
                const rectHeight = overlayCanvas.height * 0.7;
                const rectX = (overlayCanvas.width - rectWidth) / 2;
                const rectY = (overlayCanvas.height - rectHeight) / 2;
                
                context.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                context.lineWidth = 4;
                context.setLineDash([15, 10]);
                context.strokeRect(rectX, rectY, rectWidth, rectHeight);
                
                context.font = 'bold 16px Poppins';
                context.fillStyle = 'rgba(255, 255, 255, 0.9)';
                context.textAlign = 'center';
                context.fillText('Letakkan wajah anda disini', overlayCanvas.width / 2, rectY - 35);
                context.fillText('dan pandang tepat ke kamera', overlayCanvas.width / 2, rectY - 15);
            };
            guideInterval = setInterval(drawStaticGuide, 100);
        });
    }

    function startImageUploadRegistration() {
        clearAllIntervals();
        hideVideoFeed();
        registrationChoice.style.display = 'none';
        imageUploadGroup.style.display = 'flex';
        registrationForm.style.display = 'flex';
        mainMenu.style.display = 'none';
        statusMessage.innerText = "Lengkapkan borang dan muat naik gambar.";
        setPlaceholderContent('<span>Sila muat naik gambar</span>');
    }
    
    async function processRegistration(name, position, detection) {
        if (!detection) {
             statusMessage.innerText = "Wajah tidak dapat dikesan. Sila cuba lagi.";
             setTimeout(handleCancel, 3000);
             return;
        }

        const newDescriptor = detection.descriptor;
        let bestMatch = null;
        if (registeredUsers.length > 0) {
            const tempMatcher = new faceapi.FaceMatcher(registeredUsers.map(u => new faceapi.LabeledFaceDescriptors(u.name, [u.descriptor])));
            bestMatch = tempMatcher.findBestMatch(newDescriptor);
        }

        if (bestMatch && bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) {
            const matchedUser = registeredUsers.find(u => u.name === bestMatch.label);
            userToUpdate = { 
                id: matchedUser.id,
                name: name,
                position: position,
                descriptor: Array.from(newDescriptor)
            };
            updateMessage.textContent = `Wajah ini telah didaftarkan sebagai "${matchedUser.name}". Kemas kini maklumat?`;
            registrationForm.style.display = 'none';
            updateConfirmation.style.display = 'flex';
        } else {
            await saveUserData(name, position, newDescriptor);
        }
    }

    async function handleImageRegistration(file, name, position) {
        statusMessage.innerText = "Memproses imej... Sila tunggu.";
        const image = await faceapi.bufferToImage(file);
        const detection = await faceapi.detectSingleFace(image).withFaceLandmarks().withFaceDescriptor();
        await processRegistration(name, position, detection);
    }

    async function handleVideoRegistration(name, position) {
        statusMessage.innerText = "Memproses wajah... Sila tunggu.";
        const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
        await processRegistration(name, position, detection);
    }

    async function saveUserData(name, position, descriptor) {
        try {
            const descriptorArray = Array.from(descriptor);
            await addDoc(collection(db, "users"), {
                name: name,
                position: position,
                descriptor: descriptorArray
            });
            statusMessage.innerText = "Pendaftaran Berjaya!";
            setTimeout(handleCancel, 2000);
        } catch (e) {
            console.error("Error adding document: ", e);
            statusMessage.innerText = "Pendaftaran Gagal. Sila lihat konsol.";
        }
    }
    
    async function updateUserData() {
        if (!userToUpdate) return;
        statusMessage.innerText = "Mengemas kini data...";
        try {
            const userDoc = doc(db, "users", userToUpdate.id);
            await updateDoc(userDoc, {
                name: userToUpdate.name,
                position: userToUpdate.position,
                descriptor: userToUpdate.descriptor
            });
            statusMessage.innerText = "Data berjaya dikemas kini!";
            setTimeout(handleCancel, 2000);
        } catch (e) {
            console.error("Error updating document: ", e);
            statusMessage.innerText = "Gagal mengemas kini data.";
        }
    }

    function clearAllIntervals() {
        if(detectionInterval) { clearInterval(detectionInterval); detectionInterval = null; }
        if(guideInterval) { clearInterval(guideInterval); guideInterval = null; }
        if(registrationScanInterval) { clearInterval(registrationScanInterval); registrationScanInterval = null; }
        overlayCanvas.getContext('2d').clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    }

    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) {
            setPlaceholderContent('<span>Sila muat naik gambar</span>');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            setPlaceholderContent('');
            placeholder.appendChild(img);
        }
        reader.readAsDataURL(file);
    }
    
    function decodeTextEffect(finalText, element, callback) {
        let i = 0;
        const alphabet = 'アァカサタナハマヤャラワABCDEFGHIJKLMNOPQRSTUVWXYZ012356789*&%$#@!';
        element.style.opacity = 1;
        element.textContent = '';

        const decodingInterval = setInterval(() => {
            if (i >= finalText.length) {
                clearInterval(decodingInterval);
                if (callback) callback();
                return;
            }

            let currentText = finalText.substring(0, i + 1);
            for (let j = i + 1; j < finalText.length; j++) {
                currentText += alphabet.charAt(Math.floor(Math.random() * alphabet.length));
            }

            element.textContent = currentText;
            i++;
        }, 80);
    }
    
    function startMatrixAnimation() {
        const context = matrixCanvas.getContext('2d');
        matrixCanvas.width = matrixCanvas.clientWidth;
        matrixCanvas.height = matrixCanvas.clientHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const alphabet = katakana + 'ABCDEFGHIJKLMNOPQRSTUVWXYZ012356789';
        const fontSize = 16;
        const columns = matrixCanvas.width / fontSize;
        const rainDrops = Array.from({ length: Math.ceil(columns) }).fill(1);

        const draw = () => {
            context.fillStyle = 'rgba(0, 0, 0, 0.05)';
            context.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
            context.fillStyle = 'var(--matrix-green)';
            context.font = `${fontSize}px VT323, monospace`;
            for (let i = 0; i < rainDrops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                context.fillText(text, i * fontSize, rainDrops[i] * fontSize);
                if (rainDrops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) {
                    rainDrops[i] = 0;
                }
                rainDrops[i]++;
            }
        };

        const animate = () => {
            draw();
            matrixAnimationId = requestAnimationFrame(animate);
        }
        
        if (matrixAnimationId) {
            cancelAnimationFrame(matrixAnimationId);
        }
        animate();
    }

    function stopMatrixAnimation() {
        if(matrixAnimationId) cancelAnimationFrame(matrixAnimationId);
        matrixAnimationId = null;
    }
    
    function handleEscKey(e) {
        if (e.key === 'Escape') {
            handleCancel();
        }
    }

    function handleCancel() {
        clearAllIntervals();
        stopMatrixAnimation();
        registrationForm.style.display = 'none';
        registrationChoice.style.display = 'none';
        updateConfirmation.style.display = 'none';
        successScreen.style.display = 'none';
        successScreen.style.opacity = 0;
        mainMenu.style.display = 'flex';
        controls.style.display = 'block'; // Show controls again
        imageUploadInput.value = '';
        hideVideoFeed();
        stopCamera();
        setPlaceholderContent(initialPlaceholderContent);
        window.removeEventListener('keydown', handleEscKey); // Stop listening for Esc
        loadRegisteredUsers();
    }

    registerBtn.addEventListener('click', () => {
        if (registeredUsers.length >= 20) {
            statusMessage.innerText = 'Pendaftaran telah penuh (Had 20 pengguna).';
            return;
        }
        mainMenu.style.display = 'none';
        registrationChoice.style.display = 'flex';
        statusMessage.innerText = 'Pilih kaedah pendaftaran.';
    });
    registerCameraBtn.addEventListener('click', startRegistrationGuide);
    registerImageBtn.addEventListener('click', startImageUploadRegistration);
    imageUploadInput.addEventListener('change', previewImage);
    cancelChoiceBtn.addEventListener('click', handleCancel);
    cancelFormBtn.addEventListener('click', handleCancel);
    confirmUpdateBtn.addEventListener('click', updateUserData);
    cancelUpdateBtn.addEventListener('click', handleCancel);

    registrationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('name-input').value;
        const position = document.getElementById('position-input').value;
        const imageFile = imageUploadInput.files[0];
        if (!name || !position) {
            statusMessage.innerText = "Nama dan Jawatan diperlukan."; return;
        }
        clearAllIntervals();
        if (imageFile) {
            await handleImageRegistration(imageFile, name, position);
        } else {
            await handleVideoRegistration(name, position);
        }
    });
    recognizeBtn.addEventListener('click', startRecognition);

    function showError(msg) {
        errorMessage.innerText = msg;
        errorMessage.style.display = 'block';
    }
    
    // Initial App Load
    document.addEventListener('DOMContentLoaded', () => {
        setPlaceholderContent(initialPlaceholderContent);
        initializeAppFlow();
    });

</script>
</body>
</html>


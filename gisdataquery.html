<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Analyzer dengan AI</title>
    
    <!-- Pustaka Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Pustaka shpjs -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --sidebar-width: 350px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            overflow: hidden;
            background-color: var(--light-gray);
        }
        #login-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        .hidden {
            display: none !important;
        }
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background-color: #ffffff;
            border-right: 1px solid var(--border-color);
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .panel {
            background-color: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .panel h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        #map-container {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
        }
        #status-bar {
            padding: 8px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            font-size: 0.9em;
        }
        #results-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #results-list li {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            word-break: break-all;
        }
        #results-list li:hover {
            background-color: #e9ecef;
        }
        #ai-answer {
            min-height: 100px;
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #logout-btn {
            margin-top: auto;
            background-color: var(--secondary-color);
        }
        #logout-btn:hover {
            background-color: #5a6268;
        }
        .version-text {
            font-size: 0.8em;
            color: var(--secondary-color);
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="panel" style="width: 400px; text-align: center;">
            <h2>GIS Analyzer dengan AI</h2>
            <p>Sila log masuk untuk meneruskan</p>
            <button id="login-btn" style="width: 250px;">Log Masuk dengan Google</button>
            <p id="version-display-login" class="version-text"></p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="sidebar">
            <h3 id="user-display" style="text-align: center; word-break: break-all;"></h3>
            <p id="version-display-sidebar" class="version-text" style="text-align: center; margin-top: -10px; margin-bottom: 10px;"></p>
            
            <div id="ai-panel" class="panel hidden">
                <h3>1. Analisis AI (Gemini)</h3>
                <p>Tanya soalan mengenai data yang dimuat naik dalam bahasa biasa.</p>
                <textarea id="ai-question" rows="4" placeholder="Contoh: Ada berapa banyak lot berstatus 'Pertanian'?"></textarea>
                <button id="ask-ai-btn">Tanya AI</button>
                <h4>Jawapan:</h4>
                <div id="ai-answer">Menunggu soalan...</div>
            </div>

            <div id="query-panel" class="panel hidden">
                <h3>2. Carian Manual</h3>
                <select id="field-select"></select>
                <select id="operator-select">
                    <option value="equal">Sama Dengan</option>
                    <option value="like">Mengandungi</option>
                </select>
                <input type="text" id="query-value" placeholder="Nilai untuk dicari">
                <button id="query-btn">Cari</button>
            </div>

            <div id="results-container" class="panel hidden">
                <h3>3. Hasil Carian</h3>
                <p id="results-count">Tiada hasil ditemui.</p>
                <ul id="results-list"></ul>
            </div>
            
            <div id="upload-panel" class="panel">
                <h3>4. Muat Naik Fail</h3>
                <p>Pilih fail Shapefile (.zip)</p>
                <input type="file" id="shp-file-input" accept=".zip">
            </div>
            
            <button id="logout-btn">Log Keluar</button>
        </div>
        <div id="map-container">
            <div id="map"></div>
            <div id="status-bar">Sila log masuk untuk memulakan.</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";

        const APP_VERSION = "1.2.1";

        const firebaseConfig = {
            apiKey: "AIzaSyCFvfVIiXlKbgmrhzUoC7sH9birM3jFoVM",
            authDomain: "gisdata-2206c.firebaseapp.com",
            projectId: "gisdata-2206c",
            storageBucket: "gisdata-2206c.appspot.com",
            messagingSenderId: "854261474877",
            appId: "1:854261474877:web:c0baf1bd22b694b333ac54"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app);
        const provider = new GoogleAuthProvider();

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const statusBar = document.getElementById('status-bar');

        let map = null;
        let geojson_data = null;
        let currentLayer = null;
        let highlightLayer = null;
        
        const analyzeShpData = httpsCallable(functions, 'analyzeShpData');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('version-display-login').textContent = `Versi ${APP_VERSION}`;
            document.getElementById('version-display-sidebar').textContent = `Versi ${APP_VERSION}`;
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userDisplay.textContent = `Selamat Datang, ${user.displayName}!`;
                statusBar.textContent = "Sedia. Sila muat naik fail Shapefile.";
                if (!map) {
                    initializeMapAndApp();
                }
                updateMapSize();
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                statusBar.textContent = "Sila log masuk untuk memulakan.";
                if (map) {
                    map.remove();
                    map = null;
                }
            }
        });

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => console.error("Login Error:", error));
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Logout Error:", error));
        });

        // PENAMBAHAN: Fungsi khas untuk mengemas kini saiz peta
        function updateMapSize() {
            if (map) {
                // Delay untuk pastikan container visible dan DOM telah render sepenuhnya
                setTimeout(() => {
                    map.invalidateSize(true); // true = pan to center
                }, 200);
            }
        }

        function initializeMapAndApp() {
            map = L.map('map').setView([4.2105, 101.9758], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);
            
            // PENAMBAHAN: Jadikan peta responsif kepada saiz tetingkap
            window.addEventListener('resize', () => {
                if (map) {
                    map.invalidateSize();
                }
            });

            const fileInput = document.getElementById('shp-file-input');
            const queryBtn = document.getElementById('query-btn');
            const askAiBtn = document.getElementById('ask-ai-btn');

            fileInput.addEventListener('change', handleFile);
            queryBtn.addEventListener('click', executeQuery);
            askAiBtn.addEventListener('click', handleAiQuery);
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            statusBar.textContent = `Memproses fail: ${file.name}...`;
            const reader = new FileReader();

            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                clearAllLayers();

                shp.parseZip(arrayBuffer).then(geojson => {
                    geojson_data = geojson;
                    currentLayer = L.geoJSON(geojson, { onEachFeature: onEachFeature }).addTo(map);
                    
                    if (currentLayer.getBounds().isValid()) {
                        map.fitBounds(currentLayer.getBounds());
                    }
                    populateFieldSelect(geojson);
                    document.getElementById('query-panel').classList.remove('hidden');
                    document.getElementById('ai-panel').classList.remove('hidden');
                    statusBar.textContent = `Fail ${file.name} berjaya dimuatkan.`;
                }).catch(error => {
                    console.error('Ralat memproses Shapefile:', error);
                    statusBar.textContent = "Gagal memproses fail .zip. Sila pastikan ia adalah Shapefile yang sah.";
                });
            };
            reader.readAsArrayBuffer(file);
        }
        
        function onEachFeature(feature, layer) {
            if (feature.properties) {
                let popupContent = '<div style="max-height: 200px; overflow-y: auto;"><table>';
                for (const key in feature.properties) {
                    popupContent += `<tr><th style="text-align: left; padding-right: 10px;">${key}</th><td>${feature.properties[key]}</td></tr>`;
                }
                popupContent += '</table></div>';
                layer.bindPopup(popupContent);
            }
        }
        
        function handleAiQuery() {
            const userQuery = document.getElementById('ai-question').value;
            const aiAnswerDiv = document.getElementById('ai-answer');

            if (!userQuery.trim()) {
                aiAnswerDiv.textContent = "Sila masukkan soalan anda.";
                return;
            }
            if (!geojson_data || !geojson_data.features || geojson_data.features.length === 0) {
                aiAnswerDiv.textContent = "Sila muat naik fail Shapefile terlebih dahulu.";
                return;
            }

            aiAnswerDiv.textContent = "Berfikir...";
            
            const sampleProperties = geojson_data.features.slice(0, 5).map(f => f.properties);
            
            const payload = {
                query: userQuery,
                contextData: sampleProperties
            };

            analyzeShpData(payload)
                .then((result) => {
                    const answer = result.data.answer;
                    aiAnswerDiv.textContent = answer;
                })
                .catch((error) => {
                    console.error("Ralat memanggil Cloud Function:", error);
                    aiAnswerDiv.textContent = `Maaf, berlaku ralat: ${error.message}`;
                });
        }

        function populateFieldSelect(geojson) {
            const fieldSelect = document.getElementById('field-select');
            fieldSelect.innerHTML = '';
            if (geojson.features.length > 0) {
                const properties = geojson.features[0].properties;
                for (const key in properties) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    fieldSelect.appendChild(option);
                }
            }
        }

        function executeQuery() {
            clearQueryResults();
            if (!geojson_data) return;

            const field = document.getElementById('field-select').value;
            const operator = document.getElementById('operator-select').value;
            const value = document.getElementById('query-value').value.toLowerCase();

            const searchResults = geojson_data.features.filter(feature => {
                const propValue = String(feature.properties[field]).toLowerCase();
                if (operator === 'equal') {
                    return propValue === value;
                } else if (operator === 'like') {
                    return propValue.includes(value);
                }
                return false;
            });
            displayQueryResults(searchResults);
        }

        function displayQueryResults(results) {
            const resultsCount = document.getElementById('results-count');
            const resultsList = document.getElementById('results-list');
            const resultsContainer = document.getElementById('results-container');
            
            resultsCount.textContent = `${results.length} hasil ditemui.`;
            results.forEach(feature => {
                const li = document.createElement('li');
                const displayField = document.getElementById('field-select').value;
                li.textContent = `${displayField}: ${feature.properties[displayField]}`;
                li.onclick = () => {
                    const layer = L.geoJSON(feature);
                    map.flyToBounds(layer.getBounds(), { maxZoom: 18 });
                };
                resultsList.appendChild(li);
            });

            if (results.length > 0) {
                highlightLayer = L.geoJSON(results, {
                    style: { color: "#ff0000", weight: 3, opacity: 0.8 }
                }).addTo(map);
                resultsContainer.classList.remove('hidden');
            }
        }

        function clearAllLayers() {
            if (currentLayer) map.removeLayer(currentLayer);
            if (highlightLayer) map.removeLayer(highlightLayer);
            geojson_data = null;
            currentLayer = null;
            highlightLayer = null;
            clearQueryResults();
            document.getElementById('query-panel').classList.add('hidden');
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('ai-panel').classList.add('hidden');
        }

        function clearQueryResults() {
            if (highlightLayer) map.removeLayer(highlightLayer);
            document.getElementById('results-count').textContent = 'Tiada hasil ditemui.';
            document.getElementById('results-list').innerHTML = '';
            document.getElementById('results-container').classList.add('hidden');
        }
    </script>

</body>
</html>

